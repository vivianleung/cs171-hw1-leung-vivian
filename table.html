<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CS171 Homework 1</title>
  <link href='http://fonts.googleapis.com/css?family=Alef' rel='stylesheet' type='text/css'>
  <link type="text/css" href="tablepage.css" rel="stylesheet">
</head>
<body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>
        // parses tsv as text
        d3.text("unemp_states_us_nov_2013.tsv", function(text){

            // parses text as arrays per row of data, inclu headers
            var data = d3.tsv.parseRows(text);

            // isolates headers from parsed data (first item in array)
            var headers = data.shift();

            // main title for table
            var titles = 'Unemployment Rates For States <br> Monthly Rankings <br> Seasonally Adjusted <br> Dec. 2013P';

            // counts number of columns req'd (for colspan)
            var cols = headers.length;
   

            // head title for page
            var pagetitle = d3.select("body")
            .data(["Unemployment Rates For States"])
            .append("h1")
            .text(function(text) { return text; });


            // sets up table DOM
            var table = d3.select("body").append("table"),
                thead = table.append("thead"),
                tbody = table.append("tbody");

            // main title of table
            var tabletitle = table.append("caption")
            .html(titles);

            // column headers
            var i = 0;
            var colheads = thead.append("tr")
                .selectAll("th")
                .data(headers)
                .enter()
                .append("th")
                .text(function(d) { return d; })

                // sorting mechanism
                .on("click", function(){
                    var sortHead = d3.select(this);
                    var sortcol = sortHead.data();
                    var direction = sortHead.attr("class");
                    var data = tbody.selectAll("tr");
                    var heads = thead.selectAll("th");

                    if (sortcol == "State") { sortState(data, direction); }
                    else if (sortcol == "Rate" || sortcol == "Rank") { 
                        sortNumbers(data, direction, sortcol); }
                    formatcells(data);
                    // modify header class (up/down) and CSS
                    if (sortHead.classed("ascending")){
                        heads.classed({"ascending": false, "descending": false});
                        sortHead.classed("descending", true);                        
                    }
                    else {
                        heads.classed({"ascending": false, "descending": false});
                        sortHead.classed("ascending", true);
                    }
                });

            var rateArray = [];
            var rates = data.forEach(function(d) { rateArray.push(+d[2]);
                });

            console.log(rateArray);

            var rows = renderrows(tbody);
            var cells = rendercells(rows);

            sortNumbers(tbody.selectAll("tr"), "none", "Rank");
            formatcells(tbody.selectAll("tr"));
            renderchart(rows);


            function colorme(mini, maxi, value)
            {
                var color = d3.scale.linear()
                    .domain([mini, maxi])
                    .interpolate(d3.interpolateRgb)
                    .range(["green", "orangered"]);
                return color(value);
            }

            function formatcells(data)
            {
                var rowcount = 0;
                data.attr("class", function() {
                        return "row" + rowcount++; })
                    .style("background-color", function() {
                        var rowClass = d3.select(this).attr("class").substring(3);
                        if (rowClass % 2 == 0) { return "#B2D9D9"; }
                        else { return "#FFFFFF"; };
                    })
                data.selectAll("td")
                    .style("background-color", function() {
                        var cell = d3.select(this);
                        if (cell[0][0].cellIndex == 2){
                            var thisRate = +cell.data();
                            return colorme(0, d3.max(rateArray), thisRate);
                        }
                    });

                // highlighting / dehighlighting for mouseover
                data.on("mouseover", function() {
                        d3.select(this).classed("active", true);
                    })
                    .on("mouseout", function() {
                        d3.select(this). classed("active", false); });  
            }

            // sorts data by State
            function sortState(data, direction){
                data.sort(function(a,b) {
                    if (direction == "ascending") { 
                        return d3.descending(a[1], b[1]); } 
                    else { return d3.ascending(a[1], b[1]); }
                })
            }

            // sorts data by Rate
            function sortNumbers(data, direction, sortcol)
            {
                // if current sort is ascending (i.e want to sort from high to low, flip the switch)
                var makeAscend = -1;
                if (direction != "ascending") { makeAscend = 1; }

                // figure out which column is being sorted
                var i = null;
                if (sortcol == "Rank") { i = 0; }
                else { i = 2; }

                data.each(function(d){ d[i] = +d[i]; })   
                    .sort(function(a, b) {
                        if (a[i] > b[i]) { return makeAscend; }
                        else if (a[i] < b[i]) { return -makeAscend; }
                        else { 
                            if (makeAscend == 1) { return d3.ascending(a[1], b[1]); }
                            else { return d3.descending(a[1], b[1]); }
                        }
                    })
            }

            // appends rows (from sample code)
            function renderrows(tbody){    
                var rows = tbody.selectAll("tr")
                    .data(data)
                    .enter()
                    .append("tr")
                return rows;
            }

            function renderchart(rows){
                var height = d3.select("td").attr("height");
                var width = "100px";
                rows.insert("td").append("svg")
                   .attr("width", width)
                   .attr("height", height)
                   .append("rect")
                   .attr("height", height)
                   .attr("width", function(d) { 
                        return parseFloat(d[2]); })
                   .attr("background-color", function(d) {
                        return colorme(0, d3.max(rateArray), parseFloat(d[2]))
                    });
            }
            
            // appends cells for each row (from sample code)
            function rendercells(rows){

                var column = 0;
                var cells = rows.selectAll("td")
                    .data(function(row) {
                        return d3.range(cols)
                            .map(function(i) {
                                return row[ Object.keys(row)[i] ];
                        });
                    })
                    .enter()
                    .append("td")
                    .attr("class", function() {
                        if (column > cols - 1) { column = 0; }
                        return "col" + column++;
                    })
                    .text(function(d) { return d; })

                    // highlight column on mouseover
                    .on("mouseover", function(){
                        var hovercol = d3.select(this).attr("class")
                            .substring(3, 4);
                        d3.selectAll("td.col" + hovercol)
                            .classed("active", true);
                    })

                    // remove highlight from column on mouseout
                    .on("mouseout", function() {
                        var hovercol = d3.select(this).attr("class")
                            .substring(3, 4);
                        d3.selectAll("td.col" + hovercol)
                            .classed("active", false); 
                    });
            }
        });
        


    </script>
</body>
</html>
